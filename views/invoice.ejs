<!DOCTYPE html>
<html>
  <head>
    <title>Order Invoice</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/cart.css">
  </head>

  <body>
    <%- include('partials/navbar') %>

    <div class="container mt-5">
      <h2>Order Invoice</h2>

      <p><strong>Invoice Number:</strong> <%= order.invoice_number %></p>
      <p><strong>Date:</strong> <%= order.order_date.toLocaleString() %></p>
      <p><strong>Status:</strong> <span id="orderStatus"><%= order.status %></span></p>

      <table class="table table-bordered text-center mt-4">
        <thead class="table-dark">
          <tr>
            <th>Product</th>
            <th>Image</th>
            <th>Quantity</th>
            <th>Price</th>
          </tr>
        </thead>

        <tbody>
          <% items.forEach(item => { %>
            <tr>
              <td><%= item.productName %></td>
              <td><img src="/images/<%= item.image %>" width="80"></td>
              <td><%= item.quantity %></td>
              <td>$<%= Number(item.price_per_unit * item.quantity).toFixed(2) %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <h3>Total Amount: $<%= Number(order.total_amount).toFixed(2) %></h3>

            <!-- ✅ Refund Section -->
                <!-- ✅ Refund Request (Member) -->
            <div class="mt-4">
            <div id="refundMsg" class="alert d-none" role="alert"></div>

            <% if (String(order.status).toLowerCase() === 'paid' && (order.refund_status || 'None') === 'None') { %>
                <div class="card p-3">
                <h5>Request Refund</h5>

                <label class="form-label">Refund reason (required)</label>
                <textarea id="refundReason" class="form-control" rows="3"></textarea>

                <button id="refundRequestBtn"
                        class="btn btn-warning mt-3"
                        data-order-id="<%= order.order_id %>">
                    Submit Refund Request
                </button>

                <small class="text-muted d-block mt-2">
                    Admin will review your request.
                </small>
                </div>

            <% } else { %>
                <p><strong>Refund Status:</strong> <%= order.refund_status || 'None' %></p>
            <% } %>
            </div>

            <script>
            (function () {
            const btn = document.getElementById("refundRequestBtn");
            const msg = document.getElementById("refundMsg");
            const reasonEl = document.getElementById("refundReason");
            if (!btn) return;

            function show(type, text) {
                msg.classList.remove("d-none", "alert-success", "alert-danger", "alert-info");
                msg.classList.add("alert-" + type);
                msg.textContent = text;
            }

            btn.addEventListener("click", async function () {
                const orderId = Number(btn.getAttribute("data-order-id"));
                const reason = (reasonEl.value || "").trim();

                if (!reason) {
                show("danger", "Please enter a refund reason.");
                return;
                }

                btn.disabled = true;
                show("info", "Submitting refund request...");

                try {
                const res = await fetch("/api/refund/request", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ orderId: orderId, reason: reason })
                });

                const data = await res.json();

                if (!res.ok || !data.success) {
                    show("danger", "Request failed: " + (data.error || "Unknown error"));
                    btn.disabled = false;
                    return;
                }

                show("success", "Refund request submitted. Admin will review.");
                btn.textContent = "Requested";
                } catch (e) {
                show("danger", "Request failed: " + (e.message || "Network error"));
                btn.disabled = false;
                }
            });
            })();
    </script>
    <%- include('partials/footer') %>
  </body>
</html>
