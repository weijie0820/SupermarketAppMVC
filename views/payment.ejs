<!DOCTYPE html>
<html>
  <head>
    <title>Payment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/cart.css">
</head>
  </head>

  <body>
    <%- include('partials/navbar') %>

    <div class="container mt-5">

      <h2 class="text-center mb-4">Payment</h2>

      <p class="text-muted mb-4 text-center">
        <% if (order) { %>
          Order ID: <strong>#<%= order.order_id %></strong> |
          Invoice: <strong><%= order.invoice_number || '-' %></strong> |
          Status: <strong><%= order.status || 'Paid' %></strong>
        <% } else { %>
          Order not created yet | Status: <strong>Pending Payment</strong>
        <% } %>
      </p>


      <!-- Messages -->
      <% if (messages && messages.error && messages.error.length > 0) { %>
        <div class="alert alert-danger">
          <% messages.error.forEach(msg => { %>
            <p class="mb-0"><%= msg %></p>
          <% }) %>
        </div>
      <% } %>

      <% if (messages && messages.success && messages.success.length > 0) { %>
        <div class="alert alert-success">
          <% messages.success.forEach(msg => { %>
            <p class="mb-0"><%= msg %></p>
          <% }) %>
        </div>
      <% } %>

      <!-- Order Summary -->
      <div class="card mb-4">
        <div class="card-header bg-dark text-white">Order Summary</div>
        <div class="card-body">

          <table class="table table-bordered text-center mt-2">
            <thead class="table-light">
              <tr>
                <th>Product</th>
                <th>Image</th>
                <th>Qty</th>
                <th>Total</th>
              </tr>
            </thead>

            <tbody>
              <% if (items && items.length > 0) { %>
                <% items.forEach(item => { %>
                  <tr>
                    <td><%= item.productName %></td>
                    <td>
                      <!-- If your images are in /images/product_images/, change path accordingly -->
                      <img src="/images/<%= item.image %>" width="80">
                    </td>
                    <td><%= item.quantity %></td>
                    <td>$<%= Number((item.price_per_unit || item.price) * item.quantity).toFixed(2) %></td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="4" class="text-muted">No items found for this order.</td>
                </tr>
              <% } %>
            </tbody>
          </table>

          <h4 class="text-end mt-3">
            Total Amount: $<%= Number(totalAmount || 0).toFixed(2) %>
          </h4>

        </div>
      </div>

      <!-- Payment Methods -->
      <div class="row g-4">

        <!-- PayPal (Popup) -->
        <div class="col-md-4">
          <div class="card h-100">
            <div class="card-header">Pay with PayPal</div>
            <div class="card-body">
           

              <div id="paypal-button-container"></div>

              <div id="paypal-error" class="alert alert-danger mt-3 d-none"></div>

              <% if (!PAYPAL_CLIENT_ID) { %>
                <div class="alert alert-warning mt-3">
                  PayPal Client ID not found. Make sure you set <strong>PAYPAL_CLIENT_ID</strong> in your <strong>.env</strong>.
                </div>
              <% } %>
            </div>
          </div>
        </div>
        
      <!-- HitPay PayNow -->
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-header">Pay with PayNow (HitPay Sandbox)</div>
          <div class="card-body">
            <p class="text-muted">
              Click generate QR, scan with your banking app, then confirm.
            </p>

            <button id="hitpay-paynow-generate" class="btn btn-primary w-100">
              PayNow 
            </button>

            <!-- ✅ error can show even before QR -->
            <div id="hitpay-paynow-error" class="alert alert-danger mt-3 d-none"></div>

            <div id="hitpay-paynow-box" class="mt-3 d-none text-center">
              <p class="mb-2"><strong>Scan to Pay</strong></p>
              <img id="hitpay-paynow-qr" src="" style="max-width:260px;" alt="PayNow QR">

              <button id="hitpay-paynow-confirm" class="btn btn-outline-dark w-100 mt-3">
                I Have Paid (Confirm)
              </button>
            </div>
          </div>
        </div>
      </div>


    <script>
    (function () {
      const btnGen = document.getElementById("hitpay-paynow-generate");
      const box = document.getElementById("hitpay-paynow-box");
      const img = document.getElementById("hitpay-paynow-qr");
      const btnConfirm = document.getElementById("hitpay-paynow-confirm");
      const errBox = document.getElementById("hitpay-paynow-error");

      function showErr(msg) {
        box.classList.remove("d-none");
        errBox.textContent = msg;
        errBox.classList.remove("d-none");
      }

      function hideErr() {
        errBox.textContent = "";
        errBox.classList.add("d-none");
      }

      if (btnGen) {
        btnGen.addEventListener("click", async () => {
          hideErr();
          const res = await fetch("/api/hitpay/paynow/create", { method: "POST" });
          const data = await res.json();

          if (!res.ok || !data || !data.checkoutUrl) {
            showErr((data && (data.message || data.error)) ? (data.message || data.error) : "Failed to start HitPay checkout");
            return;
          }

          // ✅ redirect to HitPay hosted checkout (like your screenshot)
          window.location.href = data.checkoutUrl;
        });
      }

      if (btnConfirm) {
        btnConfirm.addEventListener("click", async () => {
          hideErr();
          const res = await fetch("/api/hitpay/paynow/confirm", { method: "POST" });
          const data = await res.json();

          if (!res.ok) {
            const msg = (data && (data.error || data.message)) ? (data.error || data.message) : "Payment not completed";
            showErr(msg + (data && data.status ? (" (status: " + data.status + ")") : ""));
            return;
          }

          if (data && data.orderId) {
            window.location.href = "/order/invoice/" + data.orderId;
            return;
          }

          showErr("Payment confirmed but missing orderId.");
        });
      }
    })();
    </script>


        <!-- NETS QR (Your routes later) -->
        <div class="col-md-4">
          <div class="card h-100">
            <div class="card-header">Pay with NETS QR</div>
            <div class="card-body">
              <p class="text-muted">
                Generate a NETS QR code and scan it to pay.
              </p>

              <form action="/payment/nets/qr" method="POST" class="mb-3">
                <input type="hidden" name="orderId" value="<%= order ? order.order_id : '' %>">
                <button type="submit" class="btn btn-success w-100">
                  Generate NETS QR
                </button>
              </form>

              <% if (qrBase64) { %>
                <div class="text-center qr-box">
                  <p class="mb-2"><strong>Scan to Pay</strong></p>
                  <img src="data:image/png;base64,<%= qrBase64 %>" alt="NETS QR">
                </div>

                <form action="/payment/nets/confirm" method="POST" class="mt-3">
                  <input type="hidden" name="orderId" value="<%= order ? order.order_id : '' %>">
                  <button type="submit" class="btn btn-outline-dark w-100">
                    I Have Paid (Confirm)
                  </button>
                </form>
              <% } %>

            </div>
          </div>
        </div>

      </div>

      <div class="d-flex gap-2 mt-4">
        <a href="/cart" class="btn btn-secondary">Back to Cart</a>
        <a href="/checkout" class="btn btn-outline-secondary">Back to Checkout</a>
      </div>

    </div>

    <%- include('partials/footer') %>

    <!-- PayPal SDK (Popup Buttons) -->
    <% if (PAYPAL_CLIENT_ID) { %>
      <script src="https://www.paypal.com/sdk/js?client-id=<%= PAYPAL_CLIENT_ID %>&currency=SGD"></script>

      <script>
        (function () {
          const errorBox = document.getElementById('paypal-error');

          function showError(msg) {
            if (!errorBox) return;
            errorBox.textContent = msg;
            errorBox.classList.remove('d-none');
          }

          paypal.Buttons({
            createOrder: function () {
              return fetch('/api/paypal/create-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // ✅ send amount, NOT orderId
                body: JSON.stringify({ amount: <%= Number(totalAmount || 0).toFixed(2) %> })
              })
              .then(function (res) {
                return res.json().then(function (data) {
                  if (!res.ok) {
                    throw new Error(
                      data && (data.message || data.error)
                        ? (data.message || data.error)
                        : 'Server error'
                    );
                  }
                  return data;
                });
              })

              .then(function (data) {
                if (!data || !data.id) {
                  showError('Failed to create PayPal order.');
                  throw new Error('No PayPal order id returned');
                }
                return data.id;
              })
              .catch(function (err) {
                showError('PayPal create order error: ' + err.message);
                throw err;
              });
            },

            onApprove: function (data) {
              return fetch('/api/paypal/capture-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // ✅ send only PayPal orderID
                body: JSON.stringify({ orderID: data.orderID })
              })
              .then(function (res) {
                return res.json().then(function (data) {
                  if (!res.ok) {
                    throw new Error(
                      data && (data.message || data.error)
                        ? (data.message || data.error)
                        : 'Server error'
                    );
                  }
                  return data;
                });
              })

              .then(function (result) {
                // ✅ must check backend success
                if (result && (result.success || result.status === "COMPLETED") && result.orderId) {
                  window.location.href = '/order/invoice/' + result.orderId;
                  return;
                }
                showError('Payment not completed.');
              })
              .catch(function (err) {
                showError('PayPal capture error: ' + err.message);
                throw err;
              });
            },

            onCancel: function () {
              showError('Payment cancelled.');
            }
          }).render('#paypal-button-container');

        })();
      </script>
      <script src="./js/hitpay.js"></script>

    <% } %>
  </body>
</html>