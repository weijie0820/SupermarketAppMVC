<!DOCTYPE html>
<html>
  <head>
    <title>Payment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/cart.css">
</head>
  </head>

  <body>
    <%- include('partials/navbar') %>

    <div class="container mt-5">

      <h2 class="text-center mb-4">Payment</h2>

      <p class="text-muted mb-4 text-center">
        Order ID: <strong>#<%= order.order_id %></strong> |
        Invoice: <strong><%= order.invoice_number || '-' %></strong> |
        Status: <strong><%= order.status || 'Pending' %></strong>
      </p>

      <!-- Messages -->
      <% if (messages && messages.error && messages.error.length > 0) { %>
        <div class="alert alert-danger">
          <% messages.error.forEach(msg => { %>
            <p class="mb-0"><%= msg %></p>
          <% }) %>
        </div>
      <% } %>

      <% if (messages && messages.success && messages.success.length > 0) { %>
        <div class="alert alert-success">
          <% messages.success.forEach(msg => { %>
            <p class="mb-0"><%= msg %></p>
          <% }) %>
        </div>
      <% } %>

      <!-- Order Summary -->
      <div class="card mb-4">
        <div class="card-header bg-dark text-white">Order Summary</div>
        <div class="card-body">

          <table class="table table-bordered text-center mt-2">
            <thead class="table-light">
              <tr>
                <th>Product</th>
                <th>Image</th>
                <th>Qty</th>
                <th>Total</th>
              </tr>
            </thead>

            <tbody>
              <% if (items && items.length > 0) { %>
                <% items.forEach(item => { %>
                  <tr>
                    <td><%= item.productName %></td>
                    <td>
                      <!-- If your images are in /images/product_images/, change path accordingly -->
                      <img src="/images/<%= item.image %>" width="80">
                    </td>
                    <td><%= item.quantity %></td>
                    <td>$<%= Number(item.price_per_unit * item.quantity).toFixed(2) %></td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="4" class="text-muted">No items found for this order.</td>
                </tr>
              <% } %>
            </tbody>
          </table>

          <h4 class="text-end mt-3">
            Total Amount: $<%= Number(totalAmount || 0).toFixed(2) %>
          </h4>

        </div>
      </div>

      <!-- Payment Methods -->
      <div class="row g-4">

        <!-- PayPal (Popup) -->
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header">Pay with PayPal</div>
            <div class="card-body">
           

              <div id="paypal-button-container"></div>

              <div id="paypal-error" class="alert alert-danger mt-3 d-none"></div>

              <% if (!PAYPAL_CLIENT_ID) { %>
                <div class="alert alert-warning mt-3">
                  PayPal Client ID not found. Make sure you set <strong>PAYPAL_CLIENT_ID</strong> in your <strong>.env</strong>.
                </div>
              <% } %>
            </div>
          </div>
        </div>

        <!-- NETS QR (Your routes later) -->
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header">Pay with NETS QR</div>
            <div class="card-body">
              <p class="text-muted">
                Generate a NETS QR code and scan it to pay.
              </p>

              <form action="/payment/nets/qr" method="POST" class="mb-3">
                <input type="hidden" name="orderId" value="<%= order.order_id %>">
                <button type="submit" class="btn btn-success w-100">
                  Generate NETS QR
                </button>
              </form>

              <% if (qrBase64) { %>
                <div class="text-center qr-box">
                  <p class="mb-2"><strong>Scan to Pay</strong></p>
                  <img src="data:image/png;base64,<%= qrBase64 %>" alt="NETS QR">
                </div>

                <form action="/payment/nets/confirm" method="POST" class="mt-3">
                  <input type="hidden" name="orderId" value="<%= order.order_id %>">
                  <button type="submit" class="btn btn-outline-dark w-100">
                    I Have Paid (Confirm)
                  </button>
                </form>
              <% } %>

            </div>
          </div>
        </div>

      </div>

      <div class="d-flex gap-2 mt-4">
        <a href="/cart" class="btn btn-secondary">Back to Cart</a>
        <a href="/checkout" class="btn btn-outline-secondary">Back to Checkout</a>
      </div>

    </div>

    <%- include('partials/footer') %>

    <!-- PayPal SDK (Popup Buttons) -->
    <% if (PAYPAL_CLIENT_ID) { %>
      <script src="https://www.paypal.com/sdk/js?client-id=<%= PAYPAL_CLIENT_ID %>&currency=SGD"></script>

      <script>
        (function () {
          const errorBox = document.getElementById('paypal-error');

          function showError(msg) {
            if (!errorBox) return;
            errorBox.textContent = msg;
            errorBox.classList.remove('d-none');
          }

          paypal.Buttons({
            createOrder: function () {
                return fetch('/api/paypal/create-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    amount: Number(<%= Number(totalAmount || 0).toFixed(2) %>)
                })
                })
                .then(function (res) { return res.json(); })
                .then(function (data) {
                if (!data || !data.id) {
                    showError('Failed to create PayPal order.');
                    throw new Error(data && data.error ? data.error : 'No PayPal order id returned');
                }
                return data.id;
                })
                .catch(function (err) {
                showError('PayPal create order error: ' + err.message);
                throw err;
                });
            },

            onApprove: function (data) {
                return fetch('/api/paypal/capture-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    orderID: data.orderID,
                    orderId: <%= order.order_id %>
                })
                })
                .then(function (res) { return res.json(); })
                .then(function (result) {
                if (result && (result.success || result.status === "COMPLETED")) {
                    window.location.href = '/order/invoice/<%= order.order_id %>';
                } else {
                    showError('Payment not completed.');
                }
                })
                .catch(function (err) {
                showError('PayPal capture error: ' + err.message);
                throw err;
                });
            }
            }).render('#paypal-button-container');
        })();
      </script>
    <% } %>
  </body>
</html>