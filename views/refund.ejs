<!DOCTYPE html>
<html>
<head>
  <title>Refund Requests</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<%- include('partials/navbar') %>

<div class="container mt-5">
  <h2>Refund Requests (Admin)</h2>

  <table class="table table-bordered mt-4">
    <thead class="table-dark">
      <tr>
        <th>Order ID</th>
        <th>User ID</th>
        <th>Reason</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>

    <tbody>
      <% refunds.forEach(r => { %>
        <tr id="row-<%= r.order_id %>">
          <td><%= r.order_id %></td>
          <td><%= r.user_id %></td>
          <td><%= r.refund_reason %></td>
          <td class="status"><%= r.refund_status %></td>
          <td>
            <% if (r.refund_status === 'RefundRequested') { %>
              <button class="btn btn-success btn-sm"
                onclick="approveRefund(<%= r.order_id %>)">
                Approve
              </button>

              <button class="btn btn-danger btn-sm ms-2"
                onclick="rejectRefund(<%= r.order_id %>)">
                Reject
              </button>
            <% } %>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<script>
async function approveRefund(orderId) {
  if (!confirm("Approve refund for Order #" + orderId + "?")) return;

  const res = await fetch("/api/admin/refund/approve", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ orderId })
  });

  const data = await res.json();

  if (!res.ok || !data.success) {
    alert("Refund failed: " + (data.error || "Unknown error"));
    return;
  }

  document.querySelector("#row-" + orderId + " .status").innerText = "Refunded";
  alert("Refund successful!");
}

async function rejectRefund(orderId) {
  const reason = prompt("Reject reason:");
  if (!reason) return;

  const res = await fetch("/api/admin/refund/reject", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ orderId, rejectReason: reason })
  });

  const data = await res.json();

  if (!res.ok || !data.success) {
    alert("Reject failed");
    return;
  }

  document.querySelector("#row-" + orderId + " .status").innerText = "RefundRejected";
}
</script>

</body>
</html>
