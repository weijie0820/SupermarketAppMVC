<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Email Verification</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom OTP CSS -->
  <link rel="stylesheet" href="/css/otp.css">
</head>

<body>

  <div class="otp-container">

    <h1 class="otp-title">Email Verification</h1>

    <!-- Error Message -->
    <% if (query && query.error) { %>
      <div class="alert alert-danger"><%= query.error %></div>
    <% } %>

    <!-- Success Message (OTP Sent) -->
    <% if (query && query.sent) { %>
      <div class="alert alert-success">
        OTP sent to <strong><%= query.email %></strong>. Check your inbox.<br>

        <% if (query.loginVerify) { %>
           <small class="text-info">üîê This OTP is required to verify your login.</small><br>
        <% } else { %>
           <small class="text-danger">‚ö† Your OTP is only valid for 1 minute.</small>
        <% } %>

      </div>
    <% } %>

    <!-- Countdown timer goes here -->
    <div id="countdownDisplay" class="countdown-text"></div>

    <div class="row mt-4">

      <!-- REQUEST OTP SECTION -->
      <div class="col-md-6">
        <p class="form-title">Enter email to request OTP</p>

        <form action="/reqOTP" method="post">
          <input 
            type="email"
            id="emailField"
            name="email"
            class="form-control mb-3"
            required
            placeholder="Enter your email"
            value="<%= query.email || '' %>"
          >
          <button class="btn btn-secondary w-100">Request OTP</button>
        </form>
      </div>

      <!-- VERIFY OTP SECTION -->
      <div class="col-md-6">
        <p class="form-title">Enter OTP</p>

        <form action="/verifyOTP" method="post">
          <input type="hidden" name="email" id="verifyEmail" value="<%= query.email || '' %>">

          <input 
            type="text" 
            id="otpField"
            name="otp" 
            maxlength="6"
            class="form-control mb-3"
            placeholder="6-digit OTP"
            required
          >

          <button class="btn btn-primary w-100">Verify OTP</button>
        </form>
      </div>

    </div>
  </div>


  <!-- COUNTDOWN + SYNC SCRIPT -->
  <script>

    // Sync hidden email field with request email input
    document.getElementById('emailField')?.addEventListener('input', function (e) {
      document.getElementById('verifyEmail').value = e.target.value;
    });

    // Detect OTP Sent
    const otpSent = "<%= (query && query.sent) ? 'true' : 'false' %>";
    const countdownBox = document.getElementById("countdownDisplay");
    const verifyBtn = document.querySelector(".btn-primary");

    if (otpSent === "true") {
      let timeLeft = 60; // 60 seconds countdown

      const interval = setInterval(() => {

        let minutes = Math.floor(timeLeft / 60);
        let seconds = timeLeft % 60;

        countdownBox.textContent = `OTP expires in ${minutes}:${seconds.toString().padStart(2, "0")}`;

        if (timeLeft <= 0) {
          clearInterval(interval);
          countdownBox.textContent = "OTP has expired. Please request a new one.";
          countdownBox.classList.add("text-warning");

          verifyBtn.disabled = true;
          verifyBtn.textContent = "OTP Expired";
        }

        timeLeft--;
      }, 1000);
    }

  </script>

</body>
</html>
